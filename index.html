<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Is it Sunny in Ireland?</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const IRISH_LOCATIONS = [
      { name: 'Dublin', lat: 53.3498, lon: -6.2603 },
      { name: 'Cork', lat: 51.8969, lon: -8.4863 },
      { name: 'Limerick', lat: 52.6638, lon: -8.6267 },
      { name: 'Galway', lat: 53.2707, lon: -9.0568 },
      { name: 'Waterford', lat: 52.2593, lon: -7.1101 },
      { name: 'Drogheda', lat: 53.7189, lon: -6.3478 },
      { name: 'Dundalk', lat: 54.0000, lon: -6.4167 },
      { name: 'Sligo', lat: 54.2697, lon: -8.4694 },
      { name: 'Kilkenny', lat: 52.6541, lon: -7.2448 },
      { name: 'Wexford', lat: 52.3369, lon: -6.4633 },
      { name: 'Killarney', lat: 52.0599, lon: -9.5044 },
      { name: 'Dingle', lat: 52.1410, lon: -10.2681 },
      { name: 'Kinsale', lat: 51.7059, lon: -8.5308 },
      { name: 'Westport', lat: 53.8004, lon: -9.5188 },
      { name: 'Doolin', lat: 53.0149, lon: -9.3776 },
      { name: 'Cobh', lat: 51.8514, lon: -8.2947 },
      { name: 'Adare', lat: 52.5632, lon: -8.7883 },
      { name: 'Howth', lat: 53.3873, lon: -6.0678 },
      { name: 'Glendalough', lat: 53.0123, lon: -6.3385 },
      { name: 'Cliffs of Moher', lat: 52.9715, lon: -9.4265 },
      { name: 'Donegal', lat: 54.6540, lon: -8.1090 },
      { name: 'Kenmare', lat: 51.8809, lon: -9.5844 },
      { name: 'Bray', lat: 53.2026, lon: -6.0983 },
      { name: 'Letterfrack', lat: 53.5504, lon: -9.9516 },
      { name: 'Bundoran', lat: 54.4778, lon: -8.2815 },
      { name: 'Athlone', lat: 53.4239, lon: -7.9406 },
      { name: 'Enniskillen', lat: 54.3436, lon: -7.6385 },
      { name: 'Carrick-on-Shannon', lat: 53.9450, lon: -8.0901 },
      { name: 'Dunmore East', lat: 52.1498, lon: -6.9943 },
      { name: 'Achill Island', lat: 53.9628, lon: -10.0903 },
      { name: 'Clifden', lat: 53.4886, lon: -10.0203 },
      { name: 'Glengarriff', lat: 51.7514, lon: -9.5519 },
      { name: 'Killybegs', lat: 54.6337, lon: -8.4483 },
      { name: 'Malahide', lat: 53.4508, lon: -6.1541 },
      { name: 'Ardmore', lat: 51.9487, lon: -7.7279 },
      { name: 'Youghal', lat: 51.9542, lon: -7.8469 },
      { name: 'Skibbereen', lat: 51.5509, lon: -9.2659 },
      { name: 'Baltimore', lat: 51.4841, lon: -9.3718 },
      { name: 'Clonmacnoise', lat: 53.3257, lon: -7.9879 },
      { name: 'Trim', lat: 53.5551, lon: -6.7914 },
      { name: 'Birr', lat: 53.0952, lon: -7.9124 },
      { name: 'Cashel', lat: 52.5166, lon: -7.8886 },
      { name: 'Dalkey', lat: 53.2796, lon: -6.1018 },
      { name: 'Dungarvan', lat: 52.0884, lon: -7.6252 },
      { name: 'Roundstone', lat: 53.4036, lon: -9.9072 },
      { name: 'Sneem', lat: 51.8315, lon: -9.9036 },
      { name: 'Cong', lat: 53.5487, lon: -9.2681 },
      { name: 'Killorglin', lat: 52.1067, lon: -9.7854 },
      { name: 'Schull', lat: 51.5270, lon: -9.5467 },
      { name: 'Leenane', lat: 53.5998, lon: -9.7047 },
      { name: 'Arranmore Island', lat: 54.9975, lon: -8.5388 },
      { name: 'Inishbofin', lat: 53.6147, lon: -10.2203 },
      { name: 'Inis Meáin', lat: 53.0920, lon: -9.5703 },
      { name: 'Belfast', lat: 54.5973, lon: -5.9301 },
      { name: 'Derry / Londonderry', lat: 54.9966, lon: -7.3086 },
      { name: 'Newry', lat: 54.1750, lon: -6.3400 },
      { name: 'Bangor', lat: 54.6534, lon: -5.6689 },
      { name: 'Lisburn', lat: 54.5162, lon: -6.0580 },
      { name: 'Coleraine', lat: 55.1333, lon: -6.6667 },
      { name: 'Portrush', lat: 55.2044, lon: -6.6550 },
      { name: 'Portstewart', lat: 55.1800, lon: -6.7150 },
      { name: 'Enniskerry', lat: 53.1917, lon: -6.1694 },
      { name: 'Greystones', lat: 53.1408, lon: -6.0631 },
      { name: 'Arklow', lat: 52.7931, lon: -6.1414 },
      { name: 'Gorey', lat: 52.6746, lon: -6.2922 },
      { name: 'Tullamore', lat: 53.2734, lon: -7.4886 },
      { name: 'Mullingar', lat: 53.5258, lon: -7.3386 },
      { name: 'Longford', lat: 53.7250, lon: -7.7950 },
      { name: 'Roscommon', lat: 53.6333, lon: -8.1833 },
      { name: 'Boyle', lat: 54.1833, lon: -8.3000 },
      { name: 'Manorhamilton', lat: 54.3067, lon: -8.1764 },
      { name: 'Ballyshannon', lat: 54.5014, lon: -8.1847 },
      { name: 'Strabane', lat: 54.8236, lon: -7.4692 },
      { name: 'Omagh', lat: 54.6000, lon: -7.3000 },
      { name: 'Cookstown', lat: 54.6431, lon: -6.7453 },
      { name: 'Dungannon', lat: 54.5033, lon: -6.7683 },
      { name: 'Banbridge', lat: 54.3487, lon: -6.2670 },
      { name: 'Downpatrick', lat: 54.3281, lon: -5.7153 },
      { name: 'Newcastle (NI)', lat: 54.2175, lon: -5.8897 },
      { name: 'Kilkeel', lat: 54.0610, lon: -6.0030 },
      { name: 'Carlingford', lat: 54.0419, lon: -6.1860 },
      { name: 'Blacklion', lat: 54.3114, lon: -7.8506 },
      { name: 'Ballycastle', lat: 55.2040, lon: -6.2420 },
      { name: 'Bushmills', lat: 55.2047, lon: -6.5192 },
      { name: 'Larne', lat: 54.8500, lon: -5.8167 },
      { name: 'Carrickfergus', lat: 54.7158, lon: -5.8092 },
      { name: 'Antrim', lat: 54.7195, lon: -6.2072 },
      { name: 'Magherafelt', lat: 54.7550, lon: -6.6060 },
      { name: 'Keady', lat: 54.2500, lon: -6.7000 },
      { name: 'Crossmaglen', lat: 54.0833, lon: -6.6000 },
      { name: 'Clogher', lat: 54.4200, lon: -7.2200 },
      { name: 'Buncrana', lat: 55.1333, lon: -7.4500 },
      { name: 'Carndonagh', lat: 55.2500, lon: -7.2667 },
      { name: 'Moville', lat: 55.2000, lon: -7.0333 },
      { name: 'Ramelton', lat: 55.0333, lon: -7.6500 },
      { name: 'Convoy', lat: 54.8600, lon: -7.6700 },
      { name: 'Castleblayney', lat: 54.1167, lon: -6.7333 },
      { name: 'Monaghan', lat: 54.2500, lon: -6.9667 },
      { name: 'Clones', lat: 54.1833, lon: -7.2333 }
    ];

    const Sun = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    );

    const Cloud = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
      </svg>
    );

    const MapPin = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
        <circle cx="12" cy="10" r="3"/>
      </svg>
    );

    const Calendar = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
    );

    const AlertTriangle = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
    );

    const Info = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
    );

    // Met Éireann weather symbol codes
    const SUNNY_SYMBOLS = new Set([
      '1', 'Sun', 'clearsky_day', 'fair_day'
    ]);

    const PARTLY_SUNNY_SYMBOLS = new Set([
      '2', '3', 'partlycloud_day', 'partlycloudy_day', 'cloudy'
    ]);

    const FEATURES = {
      WEATHER_WARNINGS: false
    };

    // Check if time is during daylight hours (6am-9pm)
    const isDaytime = (timeStr) => {
      const hour = new Date(timeStr).getHours();
      return hour >= 6 && hour <= 21;
    };

    function IsSunnyInIreland() {
      const [selectedDate, setSelectedDate] = useState(null);
      const [loading, setLoading] = useState(false);
      const [sunnyLocations, setSunnyLocations] = useState([]);
      const [userLocation, setUserLocation] = useState(null);
      const [weatherWarnings, setWeatherWarnings] = useState([]);
      const [showWarnings, setShowWarnings] = useState(false);
      const [weatherCache, setWeatherCache] = useState({});
      const [error, setError] = useState(null);

      useEffect(() => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setUserLocation({
                lat: position.coords.latitude,
                lon: position.coords.longitude
              });
            },
            (error) => {
              console.log('Location access denied, using default Dublin');
              setUserLocation({ lat: 53.3498, lon: -6.2603 });
            }
          );
        } else {
          setUserLocation({ lat: 53.3498, lon: -6.2603 });
        }

        if (FEATURES.WEATHER_WARNINGS) {
          fetchWeatherWarnings();
        }
      }, []);

      const fetchWeatherWarnings = async () => {
        try {
          const response = await fetch('https://www.met.ie/Open_Data/json/warning_EIXX.json');
          if (response.ok) {
            const data = await response.json();
            setWeatherWarnings(data.warnings || []);
          }
        } catch (error) {
          console.error('Error fetching warnings:', error);
        }
      };

      const getCachedForecast = (location) => {
        const cacheKey = `weather_${location.lat}_${location.lon}`;
        const cached = weatherCache[cacheKey];
        
        if (cached) {
          const cacheAge = Date.now() - cached.timestamp;
          if (cacheAge < 10800000) { // 3 hours
            return cached.forecast;
          }
        }
        return null;
      };

      const cacheForecast = (location, forecast) => {
        const cacheKey = `weather_${location.lat}_${location.lon}`;
        setWeatherCache(prev => ({
          ...prev,
          [cacheKey]: {
            timestamp: Date.now(),
            forecast: forecast
          }
        }));
      };

  const fetchWeatherForLocation = async (location) => {
    const cached = getCachedForecast(location);
      if (cached) return cached;

    try {
      const url = `/api/met?lat=${location.lat}&lon=${location.lon}`;
    
      const response = await fetch(url);
    
      if (!response.ok) {
          const errorText = await response.text();
          console.error(`Proxy error for ${location.name}:`, errorText);
          return null;
        }

    const xmlText = await response.text();
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

    // Check for XML parsing errors
    const parserError = xmlDoc.querySelector('parsererror');
    if (parserError) {
      console.error('XML parsing error:', parserError.textContent);
      return null;
    }

    const forecast = parseMetEireannForecast(xmlDoc);
    if (forecast && Object.keys(forecast).length > 0) {
      cacheForecast(location, forecast);
      return forecast;
    }
    
    return null;
  } catch (error) {
    console.error(`Fetch failed for ${location.name}:`, error);
    return null;
  }
};

      const parseMetEireannForecast = (xmlDoc) => {
        const times = Array.from(xmlDoc.querySelectorAll('time'));
        const dailyBuckets = {};

        for (const time of times) {
          const from = time.getAttribute('from');
          if (!from || !isDaytime(from)) continue;

          const date = from.split('T')[0];

          const symbol = time.querySelector('symbol');
          const symbolCode = symbol?.getAttribute('symbolCode') || symbol?.getAttribute('number');

          if (!symbolCode) continue;

          if (!dailyBuckets[date]) {
            dailyBuckets[date] = {
              total: 0,
              sunny: 0,
              partly: 0
            };
          }

          dailyBuckets[date].total++;

          if (SUNNY_SYMBOLS.has(symbolCode)) {
            dailyBuckets[date].sunny++;
          } else if (PARTLY_SUNNY_SYMBOLS.has(symbolCode)) {
            dailyBuckets[date].partly++;
          }
        }

        const result = {};

        for (const [date, stats] of Object.entries(dailyBuckets)) {
          const { total, sunny, partly } = stats;
          if (total === 0) continue;

          const score = (sunny + partly * 0.6) / total;
          const confidence = Math.round(score * 100);

          let label = 'unlikely';
          if (confidence >= 70) label = 'sunny';
          else if (confidence >= 40) label = 'probably sunny';

          result[date] = {
            confidence,
            label,
            breakdown: stats
          };
        }

        return result;
      };

      const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      };

      const checkSunnyLocations = async () => {
        if (!selectedDate || !userLocation) return;

        setLoading(true);
        setSunnyLocations([]);
        setError(null);

        const dateStr = selectedDate.toISOString().split('T')[0];
        const sunny = [];
        let successCount = 0;

        for (let i = 0; i < IRISH_LOCATIONS.length; i++) {
          const location = IRISH_LOCATIONS[i];
          
          if (!getCachedForecast(location) && i > 0) {
            await new Promise(resolve => setTimeout(resolve, 150));
          }
          
          const forecast = await fetchWeatherForLocation(location);
          
          if (forecast) {
            successCount++;
            const day = forecast[dateStr];

            if (day && day.confidence >= 40) {
              const distance = calculateDistance(
                userLocation.lat,
                userLocation.lon,
                location.lat,
                location.lon
              );

              sunny.push({
                ...location,
                distance: Math.round(distance),
                confidence: day.confidence,
                label: day.label
              });
            }
          }
        }

        if (successCount === 0) {
          setError('Unable to fetch weather data. The Met Éireann API may be temporarily unavailable.');
        }

        sunny.sort((a, b) => a.distance - b.distance);
        setSunnyLocations(sunny);
        setLoading(false);
      };

      const getNextSevenDays = () => {
        const days = [];
        for (let i = 0; i < 7; i++) {
          const date = new Date();
          date.setDate(date.getDate() + i);
          days.push(date);
        }
        return days;
      };

      const formatDate = (date) => {
        const options = { weekday: 'short', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-IE', options);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50">
          <div className="max-w-4xl mx-auto p-6">
            <div className="text-center mb-8">
              <h1 className="text-5xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
                <Sun size={48} className="text-yellow-500" />
                Is it Sunny in Ireland?
              </h1>
              <p className="text-gray-600">Find sunshine anywhere on the island</p>
            </div>

            {FEATURES.WEATHER_WARNINGS && weatherWarnings.length > 0 && (
              <div className="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <button onClick={() => setShowWarnings(!showWarnings)} className="w-full flex items-center justify-between text-left">
                  <div className="flex items-center gap-2">
                    <AlertTriangle className="text-yellow-600" size={20} />
                    <span className="font-semibold text-yellow-800">
                      {weatherWarnings.length} Active Weather Warning{weatherWarnings.length > 1 ? 's' : ''}
                    </span>
                  </div>
                  <span className="text-yellow-600 text-sm">{showWarnings ? 'Hide' : 'Show'}</span>
                </button>
                {showWarnings && (
                  <div className="mt-3 space-y-2">
                    {weatherWarnings.map((warning, i) => (
                      <div key={i} className="text-sm text-yellow-800">• {warning.description || 'Weather warning active'}</div>
                    ))}
                  </div>
                )}
              </div>
            )}

            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                <Calendar size={24} />
                Select a Day
              </h2>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                {getNextSevenDays().map((date, i) => (
                  <button key={i} onClick={() => setSelectedDate(date)} className={`p-4 rounded-lg border-2 transition-all ${selectedDate?.toDateString() === date.toDateString() ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'}`}>
                    <div className="text-sm font-semibold text-gray-700">
                      {i === 0 ? 'Today' : i === 1 ? 'Tomorrow' : formatDate(date)}
                    </div>
                  </button>
                ))}
              </div>
              
              <button onClick={checkSunnyLocations} disabled={!selectedDate || loading} className="w-full mt-4 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white font-semibold py-3 rounded-lg transition-colors">
                {loading ? 'Checking all locations...' : 'Find Sunshine ☀️'}
              </button>
            </div>

            {loading && (
              <div className="bg-white rounded-xl shadow-lg p-12 text-center">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p className="text-gray-600">Checking weather across Ireland...</p>
                <p className="text-sm text-gray-500 mt-2">This may take a minute</p>
              </div>
            )}

            {error && (
              <div className="bg-red-50 border border-red-200 rounded-xl shadow-lg p-6 mb-6">
                <div className="flex items-center gap-2 text-red-800 mb-2">
                  <AlertTriangle size={20} />
                  <span className="font-semibold">Error</span>
                </div>
                <p className="text-red-700">{error}</p>
                <p className="text-sm text-red-600 mt-2">Please try again later or check the Met Éireann website directly.</p>
              </div>
            )}

            {!loading && !error && sunnyLocations.length === 0 && selectedDate && (
              <div className="bg-white rounded-xl shadow-lg p-12 text-center">
                <Cloud size={64} className="mx-auto mb-4 text-gray-400" />
                <h3 className="text-2xl font-bold text-gray-700 mb-2">No sunshine found</h3>
                <p className="text-gray-600">Unfortunately, no sunny weather forecast for this day</p>
              </div>
            )}

            {!loading && sunnyLocations.length > 0 && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <Sun className="text-yellow-500" />
                  {sunnyLocations.length} Sunny Location{sunnyLocations.length > 1 ? 's' : ''} Found!
                </h3>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {sunnyLocations.map((location, i) => (
                    <div key={i} className="flex items-center justify-between p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg hover:shadow-md transition-all border border-yellow-200">
                      <div className="flex items-center gap-3 flex-1">
                        <MapPin className="text-blue-500 flex-shrink-0" size={20} />
                        <div>
                          <span className="font-medium text-gray-800 block">{location.name}</span>
                          <span className="text-xs text-gray-600 capitalize">{location.label}</span>
                        </div>
                      </div>
                      <div className="text-right">
                        <span className="text-sm text-gray-600 block">{location.distance} km</span>
                        <span className="text-xs text-green-600 font-semibold">{location.confidence}%</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="mt-8 text-center text-sm text-gray-600 bg-white rounded-lg p-4 shadow">
              <div className="flex items-center justify-center gap-2 mb-2">
                <Info size={16} />
                <span className="font-semibold">Weather Data</span>
              </div>
              <p>
                Forecast data provided by <a href="https://www.met.ie" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-medium">Met Éireann</a>, the Irish National Meteorological Service
              </p>
              <p className="text-xs mt-1 text-gray-500">
                Data cached for 3 hours per location
              </p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(
      <React.StrictMode>
        <IsSunnyInIreland />
      </React.StrictMode>
    );
  </script>
</body>
</html>
